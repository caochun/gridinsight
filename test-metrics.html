<!DOCTYPE html>
<html>
<head>
    <title>GridInsight Metrics API 测试</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .result { margin: 10px 0; padding: 10px; background-color: #f5f5f5; border-radius: 3px; }
        .error { color: red; }
        .success { color: green; }
        button { padding: 8px 16px; margin: 5px; }
        input, textarea { width: 100%; padding: 5px; margin: 5px 0; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body>
    <h1>GridInsight 指标查询API测试</h1>
    <p>基于新的Metric系统的指标管理API测试页面</p>
    
    <div class="section">
        <h2>1. 获取所有指标列表</h2>
        <button onclick="listMetrics()">获取指标列表</button>
        <div id="listResult" class="result"></div>
    </div>
    
    <div class="section">
        <h2>2. 查询单个指标</h2>
        <input type="text" id="metricId" placeholder="输入指标标识符" 
               value="中压拓扑.配变统计.配变总数">
        <button onclick="queryMetric()">查询指标</button>
        <div id="queryResult" class="result"></div>
    </div>
    
    <div class="section">
        <h2>3. 批量查询</h2>
        <textarea id="batchIds" placeholder="输入多个指标标识符，每行一个" rows="4">
中压拓扑.配变统计.配变总数
中压拓扑.拓扑不一致.配变挂接馈线不一致数量
低压用户关系.低压用户统计.全省低压用户总数
        </textarea>
        <button onclick="batchQuery()">批量查询</button>
        <div id="batchResult" class="result"></div>
    </div>

    <div class="section">
        <h2>4. 系统状态</h2>
        <button onclick="healthCheck()">健康检查</button>
        <button onclick="clearCache()">清除缓存</button>
        <div id="healthResult" class="result"></div>
    </div>

    <div class="section">
        <h2>5. 示例指标标识符</h2>
        <div style="font-size: 12px; color: #666;">
            <p><strong>基础指标示例：</strong></p>
            <ul>
                <li>中压拓扑.配变统计.配变总数</li>
                <li>中压拓扑.拓扑不一致.配变挂接馈线不一致数量</li>
                <li>低压用户关系.低压用户统计.全省低压用户总数</li>
                <li>低压用户关系.变户关系错误.变户关系不正确的低压用户数</li>
            </ul>
            <p><strong>派生指标示例：</strong></p>
            <ul>
                <li>拓扑质量.中压拓扑准确性.中压拓扑关系准确率</li>
                <li>用户关系质量.变户关系准确性.低压变户关系准确率</li>
                <li>质量评估.综合评估.综合质量指标</li>
            </ul>
        </div>
    </div>

    <script>
        const baseUrl = 'http://localhost:8080/api/metrics';
        
        async function listMetrics() {
            try {
                const response = await fetch(baseUrl + '/list');
                const data = await response.json();
                document.getElementById('listResult').innerHTML = 
                    '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
            } catch (error) {
                document.getElementById('listResult').innerHTML = 
                    '<p class="error">错误: ' + error.message + '</p>';
            }
        }
        
        async function queryMetric() {
            const identifier = document.getElementById('metricId').value;
            try {
                const response = await fetch(baseUrl + '/query?identifier=' + encodeURIComponent(identifier));
                const data = await response.json();
                const resultDiv = document.getElementById('queryResult');
                
                if (data.success) {
                    resultDiv.innerHTML = '<div class="success">查询成功</div><pre>' + JSON.stringify(data, null, 2) + '</pre>';
                } else {
                    resultDiv.innerHTML = '<div class="error">查询失败: ' + data.error + '</div><pre>' + JSON.stringify(data, null, 2) + '</pre>';
                }
            } catch (error) {
                document.getElementById('queryResult').innerHTML = 
                    '<p class="error">错误: ' + error.message + '</p>';
            }
        }
        
        async function batchQuery() {
            const identifiers = document.getElementById('batchIds').value.split('\n').filter(id => id.trim());
            try {
                const response = await fetch(baseUrl + '/batch-query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(identifiers)
                });
                const data = await response.json();
                const resultDiv = document.getElementById('batchResult');
                
                if (data.success) {
                    resultDiv.innerHTML = '<div class="success">批量查询完成 - 成功: ' + data.successCount + ', 失败: ' + data.errorCount + '</div><pre>' + JSON.stringify(data, null, 2) + '</pre>';
                } else {
                    resultDiv.innerHTML = '<div class="error">批量查询失败: ' + data.error + '</div><pre>' + JSON.stringify(data, null, 2) + '</pre>';
                }
            } catch (error) {
                document.getElementById('batchResult').innerHTML = 
                    '<p class="error">错误: ' + error.message + '</p>';
            }
        }
        
        async function healthCheck() {
            try {
                const response = await fetch(baseUrl + '/health');
                const data = await response.json();
                document.getElementById('healthResult').innerHTML = 
                    '<div class="success">系统状态正常</div><pre>' + JSON.stringify(data, null, 2) + '</pre>';
            } catch (error) {
                document.getElementById('healthResult').innerHTML = 
                    '<p class="error">健康检查失败: ' + error.message + '</p>';
            }
        }
        
        async function clearCache() {
            try {
                const response = await fetch(baseUrl + '/clear-cache', {
                    method: 'POST'
                });
                const data = await response.json();
                const resultDiv = document.getElementById('healthResult');
                
                if (data.success) {
                    resultDiv.innerHTML = '<div class="success">缓存已清除</div><pre>' + JSON.stringify(data, null, 2) + '</pre>';
                } else {
                    resultDiv.innerHTML = '<div class="error">清除缓存失败: ' + data.error + '</div><pre>' + JSON.stringify(data, null, 2) + '</pre>';
                }
            } catch (error) {
                document.getElementById('healthResult').innerHTML = 
                    '<p class="error">错误: ' + error.message + '</p>';
            }
        }
    </script>
</body>
</html>
