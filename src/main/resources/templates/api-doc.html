<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API 文档 - GridInsight</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 版本号: v3.0 - 简化版 -->
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="/admin/metrics"><i class="bi bi-journal-code"></i> API 文档</a>
        <div class="navbar-nav ms-auto">
            <a class="nav-link" href="/admin/metrics">返回管理</a>
        </div>
    </div>
    </nav>

<div class="container py-4">
    <h1 class="mb-4">指标 API</h1>

    <div class="mb-4">
        <h5>健康检查</h5>
        <pre><code>GET /api/metrics/health</code></pre>
        <button class="btn btn-sm btn-outline-primary" onclick="tryCall('/api/metrics/health')">试一试</button>
        <div class="mt-2 small text-muted" id="resp-health"></div>
    </div>

    <div class="mb-4">
        <h5>获取全部指标列表</h5>
        <pre><code>GET /api/metrics/list</code></pre>
        <button class="btn btn-sm btn-outline-primary" onclick="showAllMetrics()">查看所有指标</button>
    </div>

    <div class="mb-4">
        <h5>查询单个指标值</h5>
        <div class="mb-3">
            <h6>使用UUID查询</h6>
            <pre><code>GET /api/metrics/query-by-uuid?uuid=550e8400-e29b-41d4-a716-446655440001</code></pre>
            <div class="input-group">
                <input id="single-uuid" class="form-control" placeholder="输入指标UUID">
                <button class="btn btn-outline-success" onclick="querySingleByUuid()">查询</button>
            </div>
        </div>
        
        <!-- Tab导航 -->
        <ul class="nav nav-tabs" id="metricTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="realtime-tab" data-bs-toggle="tab" data-bs-target="#realtime-pane" type="button" role="tab" aria-controls="realtime-pane" aria-selected="true">
                    <i class="bi bi-speedometer2"></i> 实时值
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history-pane" type="button" role="tab" aria-controls="history-pane" aria-selected="false">
                    <i class="bi bi-graph-up"></i> 历史值
                </button>
            </li>
        </ul>
        
        <!-- Tab内容 -->
        <div class="tab-content" id="metricTabContent">
            <!-- 实时值Tab -->
            <div class="tab-pane fade show active" id="realtime-pane" role="tabpanel" aria-labelledby="realtime-tab">
                <div class="row g-3 mt-3">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">实时值</div>
                            <div class="card-body">
                                <div class="small" id="resp-query"><span class="text-muted">请输入UUID进行查询</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">指标定义</div>
                            <div class="card-body" id="resp-def-friendly">
                                <span class="text-muted">请输入UUID进行查询</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 历史值Tab -->
            <div class="tab-pane fade" id="history-pane" role="tabpanel" aria-labelledby="history-tab">
                <div class="mt-3">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <span>历史值图表 (最近2分钟)</span>
                                <span id="auto-refresh-status" class="badge bg-success ms-2" style="display: none;">
                                    <i class="bi bi-arrow-clockwise"></i> 自动刷新中
                                </span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="chart-container" style="position: relative; height: 400px;">
                                <canvas id="metricChart"></canvas>
                            </div>
                            <div id="chart-loading" class="text-center text-muted" style="display: none;">
                                <i class="bi bi-hourglass-split"></i> 加载中...
                            </div>
                            <div id="chart-error" class="text-center text-danger" style="display: none;">
                                <i class="bi bi-exclamation-triangle"></i> 加载失败
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="mb-4">
        <h5>清空缓存</h5>
        <pre><code>POST /api/metrics/clear-cache</code></pre>
        <button class="btn btn-sm btn-outline-danger" onclick="clearCache()">清空</button>
        <div class="mt-2 small text-muted" id="resp-clear"></div>
    </div>
</div>

<!-- 指标列表模态框 -->
<div class="modal fade" id="allMetricsModal" tabindex="-1" aria-labelledby="allMetricsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="allMetricsModalLabel">
                    <i class="bi bi-list-ul"></i> 所有指标列表
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                <div id="metrics-loading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <p class="mt-2 text-muted">正在加载指标列表...</p>
                </div>
                <div id="metrics-content" style="display: none;">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6>基础指标</h6>
                            <div id="basic-metrics-list"></div>
                        </div>
                        <div class="col-md-6">
                            <h6>派生指标</h6>
                            <div id="derived-metrics-list"></div>
                        </div>
                    </div>
                </div>
                <div id="metrics-error" class="text-center py-4" style="display: none;">
                    <i class="bi bi-exclamation-triangle text-danger" style="font-size: 2rem;"></i>
                    <p class="mt-2 text-danger">加载指标列表失败</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="refreshMetricsList()">刷新</button>
            </div>
        </div>
    </div>
</div>

<script>
// 全局变量
let metricChart = null;
let currentMetricId = null;
let autoRefreshTimer = null;

// 版本标识 - 简化版
console.log('API文档页面已加载 - 版本 v3.0');

function tryCall(path){
  fetch(path).then(r=>r.text()).then(t=>{
    document.getElementById('resp-'+path.split('/').pop()).innerText=t;
  }).catch(e=>alert(e));
}
function renderRealtimeFriendly(target, data){
  const box = document.getElementById(target);
  if (!data) { box.innerHTML = '<span class="text-danger">无返回</span>'; return; }
  if (data.success === false || data.error){
    const msg = data.error || '查询失败';
    box.innerHTML = `<div class="alert alert-danger p-2 mb-0"><i class="bi bi-exclamation-triangle"></i> ${msg}</div>`;
    return;
  }
  const val = (typeof data.value !== 'undefined') ? data.value : '-';
  const unit = data.unit || '';
  const ts = data.timestamp || '-';
  const quality = data.quality || '-';
  const id = data.identifier || data.metricIdentifier || '-';
  box.innerHTML = `
    <table class="table table-sm mb-0">
      <tr><td><strong>标识符</strong></td><td><code>${id}</code></td></tr>
      <tr><td><strong>数值</strong></td><td><span class="fw-bold">${val}</span> ${unit?`<span class="badge bg-secondary">${unit}</span>`:''}</td></tr>
      <tr><td><strong>时间</strong></td><td>${ts}</td></tr>
      <tr><td><strong>质量</strong></td><td><span class="badge ${(''+quality).toUpperCase()==='GOOD'?'bg-success':(''+quality).toUpperCase()==='BAD'?'bg-danger':'bg-secondary'}">${quality}</span></td></tr>
    </table>`;
}


function querySingleByUuid(){
  const uuid=document.getElementById('single-uuid').value.trim();
  if(!uuid){alert('请输入UUID');return}
  
  // 设置当前指标ID，用于历史数据查询
  currentMetricId = uuid;
  
  // 停止之前的自动刷新
  stopAutoRefresh();
  
  // 1) 查询实时值并友好展示
  fetch('/api/metrics/query-by-uuid?uuid='+encodeURIComponent(uuid))
    .then(r=>r.json())
    .then(data=>{ renderRealtimeFriendly('resp-query', data); })
    .catch(()=>{ document.getElementById('resp-query').innerHTML='<span class="text-danger">请求失败</span>'; })
    .then(()=>{
      // 2) 拉取定义（后台已有管理端API）
      return fetch('/admin/metrics/api?uuid='+encodeURIComponent(uuid))
        .then(r=>r.json())
        .then(data=>{
          const box = document.getElementById('resp-def-friendly');
          if(!data || !data.success || !data.metric){
            box.innerHTML = '<span class="text-danger">未找到该指标的定义</span>';
            return;
          }
          const m = data.metric;
          const isDerived = m.metricType && (''+m.metricType).toUpperCase().includes('DERIVED');
          let depsHtml = '';
          if (isDerived) {
            if (m.dependencies && m.dependencies.length>0){
              depsHtml = m.dependencies.map(d=>`<span class="badge bg-info me-1">${d.identifier}</span>`).join('');
            } else {
              depsHtml = '<span class="text-muted">无</span>';
            }
          }
          let strategyHtml = '';
          if (isDerived && m.updateStrategy){
            strategyHtml = `<tr><td><strong>更新策略</strong></td><td><span class="badge bg-primary">${m.updateStrategy}</span></td></tr>`;
            if ((m.updateStrategy+'' ).toUpperCase()==='SCHEDULED' && typeof m.calculationInterval!=='undefined'){
              strategyHtml += `<tr><td><strong>计算间隔(秒)</strong></td><td><span class="badge bg-warning text-dark">${m.calculationInterval}</span></td></tr>`;
            }
          }
          box.innerHTML = `
            <table class="table table-sm">
              <tr><td><strong>标识符</strong></td><td><code>${m.identifier||'-'}</code></td></tr>
              <tr><td><strong>UUID</strong></td><td><code class="text-success">${m.uuid||uuid}</code></td></tr>
              <tr><td><strong>名称</strong></td><td>${m.name||'-'}</td></tr>
              <tr><td><strong>分类</strong></td><td>${m.category||'-'} / ${m.subCategory||'-'}</td></tr>
              <tr><td><strong>单位</strong></td><td><span class="badge bg-secondary">${m.unit||'-'}</span></td></tr>
              <tr><td><strong>类型</strong></td><td><span class="badge ${isDerived?'bg-success':'bg-primary'}">${m.metricType||'-'}</span></td></tr>
              ${isDerived?`<tr><td><strong>依赖</strong></td><td>${depsHtml}</td></tr>`:''}
              ${strategyHtml}
              ${isDerived?`<tr><td><strong>公式</strong></td><td><div class="border rounded p-2 bg-light">${m.formula||'-'}</div></td></tr>`:''}
              <tr><td><strong>描述</strong></td><td>${m.description||'-'}</td></tr>
            </table>
          `;
        })
        .catch(()=>{
          document.getElementById('resp-def-friendly').innerHTML = '<span class="text-danger">获取指标定义失败</span>';
        });
    });
}

function clearCache(){
  fetch('/api/metrics/clear-cache',{method:'POST'})
    .then(r=>r.text()).then(t=>{document.getElementById('resp-clear').innerText=t;});
}

// 显示所有指标列表
function showAllMetrics() {
    const modal = new bootstrap.Modal(document.getElementById('allMetricsModal'));
    modal.show();
    loadMetricsList();
}

// 加载指标列表
function loadMetricsList() {
    // 显示加载状态
    document.getElementById('metrics-loading').style.display = 'block';
    document.getElementById('metrics-content').style.display = 'none';
    document.getElementById('metrics-error').style.display = 'none';
    
    fetch('/api/metrics/list')
        .then(response => response.json())
        .then(data => {
            document.getElementById('metrics-loading').style.display = 'none';
            
            if (data && data.basicMetrics && data.derivedMetrics) {
                renderMetricsList(data);
                document.getElementById('metrics-content').style.display = 'block';
            } else {
                document.getElementById('metrics-error').style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error loading metrics list:', error);
            document.getElementById('metrics-loading').style.display = 'none';
            document.getElementById('metrics-error').style.display = 'block';
        });
}

// 刷新指标列表
function refreshMetricsList() {
    loadMetricsList();
}


// 填充UUID到查询输入框
function fillUuid(uuid) {
    if (!uuid || uuid === 'N/A') {
        alert('该指标没有UUID');
        return;
    }
    document.getElementById('single-uuid').value = uuid;
    // 关闭模态框
    const modal = bootstrap.Modal.getInstance(document.getElementById('allMetricsModal'));
    if (modal) {
        modal.hide();
    }
    // 自动执行查询
    querySingleByUuid();
}

// 渲染指标列表
function renderMetricsList(data) {
    // 渲染基础指标
    const basicMetricsList = document.getElementById('basic-metrics-list');
    if (data.basicMetrics && Object.keys(data.basicMetrics).length > 0) {
        let basicHtml = '<div class="list-group">';
        for (const [identifier, metric] of Object.entries(data.basicMetrics)) {
            basicHtml += `
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${metric.name || identifier}</h6>
                            <p class="mb-1 text-muted small">${metric.description || '无描述'}</p>
                            <div class="small">
                                <span class="badge bg-primary me-1">${metric.category || ''}</span>
                                <span class="badge bg-secondary me-1">${metric.subCategory || ''}</span>
                                <span class="badge bg-info">${metric.unit || ''}</span>
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="small text-muted mb-1">UUID</div>
                            <a href="javascript:void(0)" class="text-decoration-none" onclick="fillUuid('${metric.uuid || ''}')">
                                <code class="small text-success">${metric.uuid || 'N/A'}</code>
                            </a>
                        </div>
                    </div>
                </div>
            `;
        }
        basicHtml += '</div>';
        basicMetricsList.innerHTML = basicHtml;
    } else {
        basicMetricsList.innerHTML = '<p class="text-muted">暂无基础指标</p>';
    }
    
    // 渲染派生指标
    const derivedMetricsList = document.getElementById('derived-metrics-list');
    if (data.derivedMetrics && Object.keys(data.derivedMetrics).length > 0) {
        let derivedHtml = '<div class="list-group">';
        for (const [identifier, metric] of Object.entries(data.derivedMetrics)) {
            derivedHtml += `
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${metric.name || identifier}</h6>
                            <p class="mb-1 text-muted small">${metric.description || '无描述'}</p>
                            <div class="small">
                                <span class="badge bg-success me-1">${metric.category || ''}</span>
                                <span class="badge bg-secondary me-1">${metric.subCategory || ''}</span>
                                <span class="badge bg-info">${metric.unit || ''}</span>
                            </div>
                            ${metric.formula ? `<div class="mt-1"><code class="small">${metric.formula}</code></div>` : ''}
                        </div>
                        <div class="text-end">
                            <div class="small text-muted mb-1">UUID</div>
                            <a href="javascript:void(0)" class="text-decoration-none" onclick="fillUuid('${metric.uuid || ''}')">
                                <code class="small text-success">${metric.uuid || 'N/A'}</code>
                            </a>
                        </div>
                    </div>
                </div>
            `;
        }
        derivedHtml += '</div>';
        derivedMetricsList.innerHTML = derivedHtml;
    } else {
        derivedMetricsList.innerHTML = '<p class="text-muted">暂无派生指标</p>';
    }
}

// 图表相关函数
function loadHistoryData() {
  if (!currentMetricId) {
    console.log('没有当前指标ID，无法加载历史数据');
    return;
  }
  
  // 显示加载状态
  document.getElementById('chart-loading').style.display = 'block';
  document.getElementById('chart-error').style.display = 'none';
  
  // 计算时间范围：2分钟前到现在，确保能获取到数据
  const now = new Date();
  const startTime = new Date(now.getTime() - 2 * 60 * 1000); // 2分钟前
  
  // 添加调试信息
  console.log('查询时间范围:', startTime.toLocaleString(), '到', now.toLocaleString());
  
  // 直接查询历史数据
  queryHistoryWithIdentifier(currentMetricId, startTime, now);
}

function queryHistoryWithIdentifier(identifier, startTime, endTime) {
  // 判断是否为UUID
  const isUuid = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{11,14}$/i.test(identifier);
  
  // 格式化时间为ISO格式
  const formatLocalDateTime = (date) => {
    return date.getFullYear() + '-' +
           String(date.getMonth() + 1).padStart(2, '0') + '-' +
           String(date.getDate()).padStart(2, '0') + 'T' +
           String(date.getHours()).padStart(2, '0') + ':' +
           String(date.getMinutes()).padStart(2, '0') + ':' +
           String(date.getSeconds()).padStart(2, '0');
  };
  
  console.log('查询参数 - startTime:', formatLocalDateTime(startTime), 'endTime:', formatLocalDateTime(endTime));
  
  const params = new URLSearchParams({
    start: formatLocalDateTime(startTime),
    end: formatLocalDateTime(endTime)
  });
  
  if (isUuid) {
    params.append('metricUuid', identifier);
  } else {
    params.append('metric', identifier);
  }
  
  // 防止缓存
  params.append('_t', Date.now());
  
  const fullUrl = '/api/timeseries/history?' + params.toString();
  console.log('历史数据查询完整URL:', fullUrl);
  
  fetch(fullUrl)
    .then(response => response.json())
    .then(data => {
      document.getElementById('chart-loading').style.display = 'none';
      
      console.log('历史数据查询结果:', data);
      
      if (data.success && data.data && data.data.length > 0) {
        console.log('准备渲染图表，数据点数量:', data.data.length);
        console.log('最新数据点:', data.data[data.data.length - 1]);
        console.log('所有数据点的时间戳:', data.data.map(item => item.timestamp));
        console.log('所有数据点的值:', data.data.map(item => item.value));
        renderChart(data.data);
      } else {
        console.log('数据为空或查询失败:', data);
        document.getElementById('chart-error').style.display = 'block';
        document.getElementById('chart-error').innerHTML = '<i class="bi bi-exclamation-triangle"></i> 没有找到历史数据';
      }
    })
    .catch(error => {
      console.error('Error loading history data:', error);
      document.getElementById('chart-loading').style.display = 'none';
      document.getElementById('chart-error').style.display = 'block';
      document.getElementById('chart-error').innerHTML = '<i class="bi bi-exclamation-triangle"></i> 加载失败: ' + error.message;
    });
}

function renderChart(data) {
  const ctx = document.getElementById('metricChart').getContext('2d');
  
  // 准备数据
  const labels = data.map(item => {
    const date = new Date(item.timestamp);
    return date.toLocaleString('zh-CN', {
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });
  });
  
  const values = data.map(item => parseFloat(item.value) || 0);
  
  // 更新或创建图表
  if (metricChart) {
    metricChart.data.labels = labels;
    metricChart.data.datasets[0].data = values;
    metricChart.update('none');
    console.log('图表数据已更新，数据点数量:', values.length, '最新值:', values[values.length - 1]);
  } else {
    metricChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: currentMetricId,
          data: values,
          borderColor: 'rgb(75, 192, 192)',
          backgroundColor: 'rgba(75, 192, 192, 0.1)',
          tension: 0.1,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 0 },
        scales: {
          y: {
            beginAtZero: false,
            title: { display: true, text: '数值' }
          },
          x: {
            title: { display: true, text: '时间' }
          }
        },
        plugins: {
          title: { display: true, text: '指标历史值趋势图' },
          legend: { display: true, position: 'top' }
        }
      }
    });
    console.log('新图表已创建，数据点数量:', values.length);
  }
}

// 启动自动刷新
function startAutoRefresh() {
  if (autoRefreshTimer) {
    clearInterval(autoRefreshTimer);
  }
  
  document.getElementById('auto-refresh-status').style.display = 'inline-block';
  
  autoRefreshTimer = setInterval(function() {
    if (currentMetricId && document.getElementById('history-tab').classList.contains('active')) {
      console.log('自动刷新历史数据...', new Date().toLocaleTimeString());
      loadHistoryData();
    } else {
      console.log('跳过自动刷新 - currentMetricId:', currentMetricId, 'history-tab active:', document.getElementById('history-tab').classList.contains('active'));
    }
  }, 3000);
  
  console.log('已启动自动刷新，间隔3秒');
}

// 停止自动刷新
function stopAutoRefresh() {
  if (autoRefreshTimer) {
    clearInterval(autoRefreshTimer);
    autoRefreshTimer = null;
    console.log('已停止自动刷新');
  }
  
  document.getElementById('auto-refresh-status').style.display = 'none';
}

// 页面加载完成后设置事件监听器
document.addEventListener('DOMContentLoaded', function() {
  const historyTab = document.getElementById('history-tab');
  historyTab.addEventListener('shown.bs.tab', function() {
    if (currentMetricId) {
      loadHistoryData();
      startAutoRefresh();
    } else {
      document.getElementById('chart-error').style.display = 'block';
      document.getElementById('chart-error').innerHTML = '<i class="bi bi-exclamation-triangle"></i> 请先查询一个指标';
    }
  });
  
  const realtimeTab = document.getElementById('realtime-tab');
  realtimeTab.addEventListener('shown.bs.tab', function() {
    stopAutoRefresh();
  });
});
</script>

</body>
</html>


