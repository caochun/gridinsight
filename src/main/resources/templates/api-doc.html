<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API 文档 - GridInsight</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="/admin/metrics"><i class="bi bi-journal-code"></i> API 文档</a>
        <div class="navbar-nav ms-auto">
            <a class="nav-link" href="/admin/metrics">返回管理</a>
        </div>
    </div>
    </nav>

<div class="container py-4">
    <h1 class="mb-4">指标 API</h1>

    <div class="mb-4">
        <h5>健康检查</h5>
        <pre><code>GET /api/metrics/health</code></pre>
        <button class="btn btn-sm btn-outline-primary" onclick="tryCall('/api/metrics/health')">试一试</button>
        <div class="mt-2 small text-muted" id="resp-health"></div>
    </div>

    <div class="mb-4">
        <h5>获取全部指标列表</h5>
        <pre><code>GET /api/metrics/list</code></pre>
        <button class="btn btn-sm btn-outline-primary" onclick="tryCall('/api/metrics/list')">试一试</button>
        <div class="mt-2 small text-muted" id="resp-list"></div>
    </div>

    <div class="mb-4">
        <h5>查询单个指标值</h5>
        <pre><code>GET /api/metrics/query?identifier=分类.子分类.指标名称</code></pre>
        <div class="input-group mb-2">
            <input id="single-id" class="form-control" placeholder="输入指标标识符">
            <button class="btn btn-outline-primary" onclick="querySingle()">查询</button>
        </div>
        <div class="row g-3">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">实时值</div>
                    <div class="card-body">
                        <div class="small" id="resp-query"><span class="text-muted">请输入标识符进行查询</span></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">指标定义</div>
                    <div class="card-body" id="resp-def-friendly">
                        <span class="text-muted">请输入标识符进行查询</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mb-4">
        <h5>批量查询指标值</h5>
        <pre><code>POST /api/metrics/batch-query</code>
Body: ["标识符1","标识符2"]</pre>
        <div class="input-group mb-2">
            <input id="batch-ids" class="form-control" placeholder='例如: ["测试.数据库.配变总数","测试.数据库.用户总数"]'>
            <button class="btn btn-outline-primary" onclick="queryBatch()">查询</button>
        </div>
        <div class="row g-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">批量查询结果</div>
                    <div class="card-body">
                        <div class="small" id="resp-batch"><span class="text-muted">请输入标识符数组进行查询</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mb-4">
        <h5>清空缓存</h5>
        <pre><code>POST /api/metrics/clear-cache</code></pre>
        <button class="btn btn-sm btn-outline-danger" onclick="clearCache()">清空</button>
        <div class="mt-2 small text-muted" id="resp-clear"></div>
    </div>
</div>

<script>
function tryCall(path){
  fetch(path).then(r=>r.text()).then(t=>{
    document.getElementById('resp-'+path.split('/').pop()).innerText=t;
  }).catch(e=>alert(e));
}
function renderRealtimeFriendly(target, data){
  const box = document.getElementById(target);
  if (!data) { box.innerHTML = '<span class="text-danger">无返回</span>'; return; }
  if (data.success === false || data.error){
    const msg = data.error || '查询失败';
    box.innerHTML = `<div class="alert alert-danger p-2 mb-0"><i class="bi bi-exclamation-triangle"></i> ${msg}</div>`;
    return;
  }
  const val = (typeof data.value !== 'undefined') ? data.value : '-';
  const unit = data.unit || '';
  const ts = data.timestamp || '-';
  const quality = data.quality || '-';
  const id = data.identifier || data.metricIdentifier || '-';
  box.innerHTML = `
    <table class="table table-sm mb-0">
      <tr><td><strong>标识符</strong></td><td><code>${id}</code></td></tr>
      <tr><td><strong>数值</strong></td><td><span class="fw-bold">${val}</span> ${unit?`<span class="badge bg-secondary">${unit}</span>`:''}</td></tr>
      <tr><td><strong>时间</strong></td><td>${ts}</td></tr>
      <tr><td><strong>质量</strong></td><td><span class="badge ${(''+quality).toUpperCase()==='GOOD'?'bg-success':(''+quality).toUpperCase()==='BAD'?'bg-danger':'bg-secondary'}">${quality}</span></td></tr>
    </table>`;
}

function querySingle(){
  const id=document.getElementById('single-id').value.trim();
  if(!id){alert('请输入标识符');return}
  // 1) 查询实时值并友好展示
  fetch('/api/metrics/query?identifier='+encodeURIComponent(id))
    .then(r=>r.json())
    .then(data=>{ renderRealtimeFriendly('resp-query', data); })
    .catch(()=>{ document.getElementById('resp-query').innerHTML='<span class="text-danger">请求失败</span>'; })
    .then(()=>{
      // 2) 拉取定义（后台已有管理端API）
      // 兼容带点/中文标识符，使用查询参数方式
      return fetch('/admin/metrics/api?identifier='+encodeURIComponent(id))
        .then(r=>r.json())
        .then(data=>{
          const box = document.getElementById('resp-def-friendly');
          if(!data || !data.success || !data.metric){
            box.innerHTML = '<span class="text-danger">未找到该指标的定义</span>';
            return;
          }
          const m = data.metric;
          const isDerived = m.metricType && (''+m.metricType).toUpperCase().includes('DERIVED');
          let depsHtml = '';
          if (isDerived) {
            if (m.dependencies && m.dependencies.length>0){
              depsHtml = m.dependencies.map(d=>`<span class="badge bg-info me-1">${d.identifier}</span>`).join('');
            } else {
              depsHtml = '<span class="text-muted">无</span>';
            }
          }
          let strategyHtml = '';
          if (isDerived && m.updateStrategy){
            strategyHtml = `<tr><td><strong>更新策略</strong></td><td><span class="badge bg-primary">${m.updateStrategy}</span></td></tr>`;
            if ((m.updateStrategy+'' ).toUpperCase()==='SCHEDULED' && typeof m.calculationInterval!=='undefined'){
              strategyHtml += `<tr><td><strong>计算间隔(秒)</strong></td><td><span class="badge bg-warning text-dark">${m.calculationInterval}</span></td></tr>`;
            }
          }
          box.innerHTML = `
            <table class="table table-sm">
              <tr><td><strong>标识符</strong></td><td><code>${m.identifier||id}</code></td></tr>
              <tr><td><strong>名称</strong></td><td>${m.name||'-'}</td></tr>
              <tr><td><strong>分类</strong></td><td>${m.category||'-'} / ${m.subCategory||'-'}</td></tr>
              <tr><td><strong>单位</strong></td><td><span class="badge bg-secondary">${m.unit||'-'}</span></td></tr>
              <tr><td><strong>类型</strong></td><td><span class="badge ${isDerived?'bg-success':'bg-primary'}">${m.metricType||'-'}</span></td></tr>
              ${isDerived?`<tr><td><strong>依赖</strong></td><td>${depsHtml}</td></tr>`:''}
              ${strategyHtml}
              ${isDerived?`<tr><td><strong>公式</strong></td><td><div class="border rounded p-2 bg-light">${m.formula||'-'}</div></td></tr>`:''}
              <tr><td><strong>描述</strong></td><td>${m.description||'-'}</td></tr>
            </table>
          `;
        })
        .catch(()=>{
          document.getElementById('resp-def-friendly').innerHTML = '<span class="text-danger">获取指标定义失败</span>';
        });
    });
}
function queryBatch(){
  let ids=document.getElementById('batch-ids').value.trim();
  try{ JSON.parse(ids); }catch(e){ alert('请输入合法JSON数组'); return; }
  fetch('/api/metrics/batch-query',{method:'POST',headers:{'Content-Type':'application/json'},body:ids})
    .then(r=>r.json())
    .then(data=>{ renderBatchFriendly('resp-batch', data); })
    .catch(()=>{ document.getElementById('resp-batch').innerHTML='<span class="text-danger">请求失败</span>'; });
}

function renderBatchFriendly(target, data){
  const box = document.getElementById(target);
  if (!data) { box.innerHTML = '<span class="text-danger">无返回</span>'; return; }
  if (data.success === false || data.error){
    const msg = data.error || '查询失败';
    box.innerHTML = `<div class="alert alert-danger p-2 mb-0"><i class="bi bi-exclamation-triangle"></i> ${msg}</div>`;
    return;
  }
  
  if (!data.successResults || Object.keys(data.successResults).length === 0) {
    box.innerHTML = '<span class="text-muted">无成功结果</span>';
    return;
  }
  
  let html = '<div class="row g-3">';
  for (const [identifier, result] of Object.entries(data.successResults)) {
    const val = result.value || '-';
    const unit = result.unit || '';
    const ts = result.timestamp || '-';
    const quality = result.quality || '-';
    const id = result.identifier || identifier;
    
    html += `
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <strong>${identifier}</strong>
          </div>
          <div class="card-body">
            <table class="table table-sm mb-0">
              <tr><td><strong>标识符</strong></td><td><code>${id}</code></td></tr>
              <tr><td><strong>数值</strong></td><td><span class="fw-bold">${val}</span> ${unit?`<span class="badge bg-secondary">${unit}</span>`:''}</td></tr>
              <tr><td><strong>时间</strong></td><td>${ts}</td></tr>
              <tr><td><strong>质量</strong></td><td><span class="badge ${(''+quality).toUpperCase()==='GOOD'?'bg-success':(''+quality).toUpperCase()==='BAD'?'bg-danger':'bg-secondary'}">${quality}</span></td></tr>
            </table>
          </div>
        </div>
      </div>
    `;
  }
  html += '</div>';
  
  if (data.errorResults && Object.keys(data.errorResults).length > 0) {
    html += '<div class="mt-3"><h6 class="text-danger">错误结果：</h6>';
    for (const [identifier, error] of Object.entries(data.errorResults)) {
      html += `<div class="alert alert-warning p-2 mb-2"><strong>${identifier}:</strong> ${error}</div>`;
    }
    html += '</div>';
  }
  
  box.innerHTML = html;
}
function clearCache(){
  fetch('/api/metrics/clear-cache',{method:'POST'})
    .then(r=>r.text()).then(t=>{document.getElementById('resp-clear').innerText=t;});
}
</script>

</body>
</html>


